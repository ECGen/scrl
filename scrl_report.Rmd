---
title: "Rock Lichen data from Sunset Crater"
author: M.K. Lau 
output: 
html_document: 
keep_md: yes

---

# Data Summary

- This is an analysis of the effect of Pinyon Pine tree traits on
  the saxicole (lichen and moss) community on rocks under the canopy
  of the trees. 
- Trees were sampled in a pairwise design in which pairs were
  comprised of one tree that is susceptible to the herbivory of a stem
  boring moth (*Diorictria abietella*) and an adjacent tree that is
  resistant to the moth. 
- As tree resistance to the moth is genetically based, pairwise
  sampling was conducted in order to isolate this genetic effect.
- Some trees that were sampled were dead, these trees were removed
  from the analysis. 
- Plant data were observed by R. Michalet
   - Vegetation.xlsx
   - Light penetration.xls
   - light_&_litter(1).xls


# Main Results

- Rock epiphyte communities were adequately sampled, based on species
  accumulation curves, with moth resistant trees accumulating slightly
  more lichen species.
- Several tree variables, including light availability, leaf litter
  abundance and rock abundance, were impacted by moth susceptibility,
  creating strong differences in sub-canopy conditions. 
- Saxicole community abundance, richness, diversity, composition were
  significantly, generally negatively, affected by moth herbivory. 
- Correlation analysis supported an indirect link between genetically
  based moth susceptibility and impacts on lichen communities via
  decreasing rock (i.e. habitat) availability through increased leaf
  abscission and accumulation on rocks under trees.

# Analysis and Results

Analyses were conducted in the **R** statistical programming
language. The following section loads dependencies and custom
functions used in the analysis. 

## Dependencies

```{r deps, echo = TRUE, results = "hide", eval = TRUE}

cran.pkgs <- c("reshape2", "vegan", "ecodist", "xtable", "knitr",
               "semPlot", "lavaan", "piecewiseSEM", "distantia", 
               "tidySEM", "readxl")

## install packages that are not installed
if (any(!(cran.pkgs %in% installed.packages()[, 1]))){
    sapply(cran.pkgs[which(!(cran.pkgs %in% 
                             installed.packages()[, 1]))], 
           install.packages, 
           dependencies = TRUE, 
           repos = 'http://cran.us.r-project.org')
}

## Load libraries
sapply(cran.pkgs, library, quietly = TRUE, character.only = TRUE)

## Custom Functions

## se: Calculate the standard error of a variable.
se <- function(x){sd(x) / sqrt(length(x))}

```

## Load Data


The following are variable descriptions (Variable, Type, Range, Definition):

- Moth,categorical,0 or 1,Was the tree susceptible (0) or resistant (1) to moth attack
- Live/Dead,categorical,0 or 1,Was the tree dead (0) or alive (1)
- Litter %,continuous,0 to 100,Percent cover inside quadrat
- Rocks > 3cm %,continuous,0 to 100,Percent cover of rocks > 3cm? inside quadrat
- Rocks < 3cm %,continuous,0 to 100,Percent cover of rocks < 3cm? inside quadrat
- Shrubs %,continuous,0 to 100,Percent cover of shrubs inside quadrat
- Grass %,continuous,0 to 100,Percent cover of grass inside quadrat
- Branches %,continuous,0 to 100,Percent cover of branches on ground inside quadrat
- Distance,continuous,0 to 100,"Distance from main trunk, converted to percent of crown radius at that azimuth"
- Azimuth,continuous,0 to 360,Compass direction from main trunk
- Slope,continuous,0 to 90,Topographical steepness
- Aspect,continuous,0 to 360,Compass direction of slope
- Light,continuous,,Amount of light available to epiliths

```{r data-load-lich, results = "hide"}

## Data are in ../data/scrl
l.dat <- read.csv("./data/spp_env_combined.csv")

## Fix species names
colnames(l.dat)[colnames(l.dat) == "Acasup"] <- "Acaame"

## Summary of data
summary(l.dat)

## remove dead trees
l.dat <- l.dat[l.dat[, "Live.Dead"] != 0, ]

## Lichen species list
spp.l <- c("Acacon", "Acaame", "Acaobp", "Sterile.sp", "Brown.cr",
"Lobalp", "Canros", "Calare", "Phydub", "Rhichr", "Xanlin", "Xanpli",
"Xanele", "GrBr.cr", "Gray.cr")
spp.moss <- c("Synrur", "Cerpur.Bryarg")

## Create a community matrix
com <- l.dat[, colnames(l.dat) %in% c(spp.l, spp.moss)]
com.moss <- l.dat[, colnames(l.dat) %in% spp.moss]

## Add the tree labels to the rownames
rownames(com) <- paste(l.dat[, "Moth"], l.dat[, "Tree.pairs"], sep = "_")
rownames(com.moss) <- paste(l.dat[, "Moth"], l.dat[, "Tree.pairs"], sep = "_")
rownames(l.dat) <- paste(l.dat[, "Moth"], l.dat[, "Tree.pairs"], sep = "_")

## Paired environmental differences
total.rocks  <- apply(l.dat[, c("Big.rocks..", "Small.rocks..")], 1, sum)
env <- l.dat[, c("Litter..", "Big.rocks..", "Small.rocks..", 
                           "Shrubs..", "Grass..", "Branches..", 
                           "Light...N", "Light...S", "Light...average")]
env <- cbind(env, total.rocks)
env.dif <- apply(env, 2, function(x, p) tapply(x, p, diff), p = l.dat[, "Tree.pairs"])

```

## Saxicole communities were sufficiently sampled

```{r specacum}

spa.all <- specaccum(com, method = "exact")
spa.res <- specaccum(com[l.dat[, "Moth"] == 1, ], method = "exact")
spa.sus <- specaccum(com[l.dat[, "Moth"] == 0, ], method = "exact")

plot(spa.all,
     ylim = c(0, 20),
     xlab = "Cumulative Trees Sampled",
     ylab = "Species Observed", 
     col = "grey", ci.col = 'lightgrey', ci.type = "poly", ci.lty = 0)
plot(spa.res, ci.col = "black", ci.type = "bar", lty = 1, add = TRUE, ci.lty = 1)
plot(spa.sus, ci.col = "black", ci.type = "bar", lty = 3, add = TRUE, ci.lty = 3)
legend("bottomright", 
       legend = c("All", "Resistant", "Susceptible"), 
       lty = c(1, 1, 3), lwd = c(5, 2, 2), col = c("lightgrey", "black", "black"))

```

```{r specaccum-plot, cache = TRUE}

pdf("./results/scrl_spp-accum.pdf", width = 5, height = 5)
plot(spa.all,
     ylim = c(0, 20),
     xlab = "Cumulative Trees Sampled",
     ylab = "Species Observed", 
     col = "grey", ci.col = 'lightgrey', ci.type = "poly", ci.lty = 0)
plot(spa.res, ci.col = "black", ci.type = "bar", lty = 1, add = TRUE, ci.lty = 1)
plot(spa.sus, ci.col = "black", ci.type = "bar", lty = 3, add = TRUE, ci.lty = 3)
legend("bottomright", 
       legend = c("All", "Resistant", "Susceptible"), 
       lty = c(1, 1, 3), lwd = c(5, 2, 2), col = c("lightgrey", "black", "black"))
dev.off()


```

## Moth trees have different microenvironments 

```{r env-effects, cache = TRUE}

env.test.l <- apply(env.dif, 2, t.test)
env.test.l <- lapply(env.test.l, unlist)
env.test.tab <- do.call(rbind, env.test.l)
env.test.tab <- env.test.tab[, c(1, 2, 3, 6, 4, 5)]
env.test.tab <- apply(env.test.tab, 2, as.numeric)
rownames(env.test.tab) <- names(env.test.l)
colnames(env.test.tab) <- c("t", "df", "p-value", "Mean Difference", "Lower CI 95%", "Upper CI 95%")
kable(env.test.tab, digits = 4)

```


## Moth trees have different lichen communities 


```{r com-effects}

abun <- apply(com, 1, sum)
rich <- apply(com, 1, function(x) sum(sign(x)))
shan <- apply(com, 1, diversity, index = "shannon")
tt.a <- t.test(tapply(abun, l.dat[, "Tree.pairs"], diff))
tt.r <- t.test(tapply(rich, l.dat[, "Tree.pairs"], diff))
tt.h <- t.test(tapply(shan, l.dat[, "Tree.pairs"], diff))
tt.arh <- do.call(rbind, 
                  list(a = unlist(tt.a), 
                       r = unlist(tt.r), 
                       h = unlist(tt.h)))
tt.arh <- apply(tt.arh[, 1:6], 2, as.numeric)
ard.mu <- rbind(tapply(abun, l.dat[, "Moth"], mean),
                tapply(rich, l.dat[, "Moth"], mean),
                tapply(shan, l.dat[, "Moth"], mean))
ard.se <- rbind(tapply(abun, l.dat[, "Moth"], se),
                tapply(rich, l.dat[, "Moth"], se),
                tapply(shan, l.dat[, "Moth"], se))
ard.tab <- cbind(ard.mu[, "0"], ard.se[, "0"],
                 ard.mu[, "1"], ard.se[, "1"])
colnames(ard.tab) <- c("Susceptible Mean", "Susceptible SE",
                       "Resistant Mean", "Resistant SE")
rownames(ard.tab) <- c("Abundance", "Richness", "Diversity (Shannon)")

```

```{r table-ard, results = "asis"}

kable(ard.tab, digits = 3)

```

```{r table-ttests-arh, results = "asis"}

kable(tt.arh, digits = 3)

```


Composition is different (PERMANOVA, in text and supplement)

```{r table-perms, cache = TRUE}

com.ds <- cbind(com, ds = rep(0.0001, nrow(com)))
com.ds.rel <- apply(com, 2, function(x) x/max(x))
com.ds.rel <- cbind(com.ds.rel, ds = rep(0.0001, nrow(com)))
com.ds.rel[is.na(com.ds.rel)] <- 0

set.seed(123)
ptab.moth <- adonis2(com.ds~ Moth, data = l.dat, 
                    strata = l.dat[, "Tree.pairs"], 
                    by = "margin", nperm = 100000)
set.seed(123)
ptab.moth.rel <- adonis2(com.ds.rel ~ Moth, data = l.dat, 
                         strata = l.dat[, "Tree.pairs"], 
                         by = "margin", nperm = 100000)

kable(ptab.moth)
kable(ptab.moth.rel)

```

three main species were reduced by moths (FDR paired t-tests, in text + supplement)

```{r indspp}

ind.spp <- apply(com, 2, function(x, p) t.test(tapply(x, p, diff)), p = l.dat[, "Tree.pairs"])
isp <- apply(do.call(rbind, lapply(ind.spp, unlist)), 2, as.numeric)
rownames(isp) <- names(ind.spp)
isp[, "p.value"] <- p.adjust(isp[, "p.value"], method = "fdr")
isp.all <- isp[, !(apply(isp, 2, function(x) all(is.na(x))))]
isp <- isp[order(isp[, "p.value"]), ]

```

```{r table-indspp}

isp.all <- isp.all[, c(1, 2, 3, 6, 4, 5)]
colnames(isp.all) <- c("t", "df", "p-value", "Mean Difference", "Lower CI 95%", "Upper CI 95%")
kable(isp.all, digits = 4)

```

```{r write-table-isp}

write.csv(round(isp.all, 5), file = "results/scrl_isp_table.csv")

```

Calculate the average abundances of the indicators

```{r isp-avg-abund}

isp.names <- as.character(na.omit(rownames(isp[isp[, "p.value"] < 0.05, ])))
isp.com <- com[,colnames(com) %in% isp.names]
isp.dif <- apply(isp.com, 2, function(x,y) tapply(x, y, diff), y = l.dat[ ,"Tree.pairs"])

```



Create a multi-bar plot figure for the community.

```{r plot-isp, cache = TRUE}

isp.dat <- melt(isp.dif)
colnames(isp.dat) <- c("Tree.pairs", "Species", "diff")
isp.mu <- tapply(isp.dat[, "diff"], isp.dat[, "Species"], mean)
isp.se <- tapply(isp.dat[, "diff"], isp.dat[, "Species"], se)
ard.dif <- cbind(tapply(abun, l.dat[, "Tree.pairs"], diff), 
                 tapply(rich, l.dat[, "Tree.pairs"], diff), 
                 tapply(shan, l.dat[, "Tree.pairs"], diff))
colnames(ard.dif) <- c("Abundance", "Richness", "Diversity")
ard.dat <- melt(ard.dif)
colnames(ard.dat) <- c("Tree.pairs", "Stat", "diff")
ard.mu <- tapply(ard.dat[, "diff"], ard.dat[, "Stat"], mean)
ard.se <- tapply(ard.dat[, "diff"], ard.dat[, "Stat"], se)

pdf(file = "./results/scrl_isp_ard.pdf", width = 9, height = 5)

par(mfrow = c(1,2))
bp.out <- barplot(ard.mu, col = "darkgrey", ylim = c(-5, 0), 
                  ylab = "Difference (S - R)", border = "NA")
segments(bp.out[, 1], ard.mu + ard.se,
         bp.out[, 1], ard.mu - ard.se, 
         lwd = 1.5)
bp.out <- barplot(isp.mu, col = "darkgrey", ylim = c(-0.5, 0), 
                  ylab = "Difference (S - R)", border = "NA",
			axisnames = TRUE, 
			names.arg = sapply(names(isp.mu), 
				function(x) 
                                    paste(c(substr(x, 1, 1), 
                                            substr(x, 4, 4)), collapse = "")))
segments(bp.out[, 1], isp.mu + isp.se,
         bp.out[, 1], isp.mu - isp.se, 
         lwd = 1.5)
dev.off()

```

Create a plot of the two most indicative species

```{r plot-isp-lich, cache = TRUE}

pdf(file = "./results/scrl_complot.pdf", width = 7, height = 7)
plot(com[, c("Acaame", "Canros")], pch = l.dat[, "Moth"] + 1, cex = 3, col = l.dat[, "Moth"] + 1)
legend("topleft", title = "Tree Type", legend = c("Resistant", "Susceptible"), pch = c(2, 1), col = c(2, 1))
dev.off()

```

Create plot with indicator taxa

```{r plot-isp-dif, cache = TRUE}

pdf(file = "./results/scrl_pdif.pdf", width = 7, height = 7)
plot(melt(isp.dif)[-1], xlab = "Species", ylab = "Abundance Reduction")
dev.off()

```


## Litter covering rocks was the main driver 

Although light did significantly explain variation in the lichen
community, this was not significant once the variation in litter was
controlled for. 

There was high correlation among environmental variables.

```{r plot-envcor-heatmap, cache = TRUE}

heatmap(abs(round(cor(env.dif), 3)))

```


```{r table-perm-env-lich}


set.seed(123)
ptab.env <- adonis2(com.ds ~ Litter.. +  Light...average, data = l.dat, 
                   strata = l.dat[, "Tree.pairs"], 
                   by = "margin", nperm = 100000)
kable(ptab.env)

set.seed(123)
ptab.env <- adonis2(com.ds ~ Light...average + Litter.. , data = l.dat, 
                   strata = l.dat[, "Tree.pairs"], 
                   by = "margin", nperm = 100000)
kable(ptab.env)

set.seed(123)
ptab.env <- adonis2(com.ds ~ Litter.. +  Light...average + Litter.. *  Light...average, data = l.dat, 
                   strata = l.dat[, "Tree.pairs"], 
                   by = "margin", nperm = 100000)
kable(ptab.env)


set.seed(123)
ptab.env <- adonis2(com.ds ~ total.rocks ,
                   strata = l.dat[, "Tree.pairs"], 
                   by = "term", nperm = 100000)

kable(ptab.env)
set.seed(123)
ptab.env <- adonis2(com.ds ~ Big.rocks.. , data = l.dat, 
                   strata = l.dat[, "Tree.pairs"], 
                   by = "term", nperm = 100000)

kable(ptab.env)
set.seed(123)
ptab.env <- adonis2(com.ds ~ Small.rocks.. , data = l.dat, 
                   strata = l.dat[, "Tree.pairs"], 
                   by = "term", nperm = 100000)
kable(ptab.env)
set.seed(123)
ptab.env <- adonis2(com.ds ~ Litter.. , data = l.dat, 
                   strata = l.dat[, "Tree.pairs"], 
                   by = "term", nperm = 100000)
kable(ptab.env)


```

Because light was significantly, negatively correlated with litter and
large rocks.

```{r plot-litter-rockbig, cache = TRUE}

cor.test(env.dif[, "Big.rocks.."], env.dif[, "Litter.."])

pdf("./results/scrl_litterVbigrocks.pdf", width = 5, height = 5)
dev.off()

```


```{r litter-plot, cache = TRUE, fig.width = 10, fig.height = 5}

par(mfrow = c(1,3))
plot(density(tapply(l.dat[, "Litter.."], l.dat[, "Tree.pairs"], diff)), 
	main = "", xlab = "Litter Difference (S - R)")
abline(v = mean(tapply(l.dat[, "Litter.."], l.dat[, "Tree.pairs"], diff)),
	lwd = 0.5)
plot(env.dif[, "Big.rocks.."] ~ env.dif[, "Litter.."], 
     xlab = "Litter Difference (S - R)", ylab = "Rock Cover (size >3 cm) Difference (S - R)",
     pch = 19, cex = 1.5)
abline(lm(env.dif[, "Big.rocks.."] ~ env.dif[, "Litter.."]))
plot(tapply(l.dat[, "Litter.."], l.dat[, "Tree.pairs"], diff), 
	tapply(l.dat[, "Light...average"], l.dat[, "Tree.pairs"], diff), 
	xlab = "Litter Difference (S - R)", ylab = "Light Difference (S - R)",
	pch = 19, cex = 1.5)

```

```{r pdf-litter-plot, cache = TRUE}

pdf("./results/scrl_litter_effects.pdf", width = 10, height = 5)
par(mfrow = c(1,3))
plot(density(tapply(l.dat[, "Litter.."], l.dat[, "Tree.pairs"], diff)), 
	main = "", xlab = "Litter Difference (S - R)")
abline(v = mean(tapply(l.dat[, "Litter.."], l.dat[, "Tree.pairs"], diff)),
	lwd = 0.5)
plot(env.dif[, "Big.rocks.."] ~ env.dif[, "Litter.."], 
     xlab = "Litter Difference (S - R)", ylab = "Rock Cover (size >3 cm) Difference (S - R)",
     pch = 19, cex = 1.5)
abline(lm(env.dif[, "Big.rocks.."] ~ env.dif[, "Litter.."]))
plot(tapply(l.dat[, "Litter.."], l.dat[, "Tree.pairs"], diff), 
	tapply(l.dat[, "Light...average"], l.dat[, "Tree.pairs"], diff), 
	xlab = "Litter Difference (S - R)", ylab = "Light Difference (S - R)",
	pch = 19, cex = 1.5)
dev.off()

```

```{r ord-com-plot, cache = TRUE, width = 5, height = 5, dpi = 400}

nmds.out <- nmds(vegdist(com.ds), 2, 2)
ord <- nmds.min(nmds.out, dims = 2)
ord.pch <- c("R", "S")[(l.dat[, "Moth"] + 1)]
plot(X2~ X1, data = ord, pch = ord.pch)

```

Litter not light was correlated with large rocks (dist cor, in text).
Thus, higher amounts of litter under trees was not related to the
penetration of light under the tree canopy.

```{r cor-lichen, cache = TRUE}

cor.test(tapply(l.dat[, "Big.rocks.."], l.dat[, "Tree.pairs"], diff),
         tapply(l.dat[, "Litter.."], l.dat[, "Tree.pairs"], diff))
cor.test(tapply(l.dat[, "Big.rocks.."], l.dat[, "Tree.pairs"], diff),
         tapply(l.dat[, "Light...average"], l.dat[, "Tree.pairs"], diff))
cor.test(tapply(l.dat[, "Litter.."], l.dat[, "Tree.pairs"], diff),
         tapply(l.dat[, "Light...average"], l.dat[, "Tree.pairs"], diff))
cor.test(tapply(l.dat[, "Small.rocks.."], l.dat[, "Tree.pairs"], diff),
         tapply(l.dat[, "Litter.."], l.dat[, "Tree.pairs"], diff))


```

# Vegetation Analysis

## Results Summary

- Both vegetation and light from the plant dataset respond to moth
  susceptibility (see t-tests below)
- Plant cover, richness and Shannon's diversity respond to moth
  susceptibility (see t-tests below)
- Plant community composition using Bray-Curtis dissimiliarity and a
  PERMANOVA model that accounts for tree pairs is significantly
  affected by moth susceptibility (Tables 11-12)
- Using the light, littter and rock cover from the saxicole dataset,
  plant community composition is significantly correlated with light
  and litter but not rock cover. Light has a strong effect but the
  effect of litter is weak and is non-significant after controlling
  for the effect of light, suggesting that the effect of litter is due
  to the covariance between light and litter (Tables 13-16) 
- Two main species of plant were indicators of moth susceptibility:
  Apache plume and *Asteraceae ovales*. Both showed reduced cover
  under moth susceptible trees (Table 17)
- Saxicole and plant communities were not multivariately correlated
  based on Mantel Tests on both un-relatvized and species max
  relativized cover (see Mantel Test below)

## From Richard Michalet

> First sheet is the vegetation matrix with all relevÃ©s.

> Second sheet are values of vegetation cover, rock cover and species
> richness in all replicates of all treatments + mean values of
> treatments and corresponding graphs.

> From what I remember the methods were simple, quadrats of 1square
> meter in four treatments with a full factorial design, exposure (north
> and south of the tree), mortality (alive vs dead shrubs), tree
> susceptibility (resistant vs susceptible) and tree presence (below the
> canopy or outside the canopy in open conditions at the close vicinity
> of the trees).


> You can see that without stats results are obvious: strong effect of
> tree susceptibility only below the tree and in both exposure for both
> alive and dead trees.

```{r data-veg, results = "hide"}

veg <- readxl::read_xlsx("data/Vegetation.xlsx")
veg <- as.data.frame(veg)
l.raw <- read.csv("data/rawdata Sunset Crater for Matt.csv")
l.raw <- l.raw[!(grepl("cover", l.raw[,1])),]
le.raw <- read.csv("data/rawdata Sunset Crater for Matt_env.csv")
le.raw <- le.raw[!(grepl("cover", le.raw[,1])),]
le.raw <- na.omit(le.raw)

```

## Observation checks

Do the saxicole community and environment data match?

```{r data-veg-check, echo = FALSE}

all(apply(l.raw[,1:3], 2, as.character) == apply(le.raw[,1:3], 2, as.character))

```

Are all of the trees in the saxicole dataset represented in the veg dataset?

```{r data-veg-check-treeid, echo = FALSE}

all(unlist(lapply(lapply(l.raw[, "Tree.ID"], grepl, x = veg[, "Tree ID"]), any)))

```

## Coalesce datasets


```{r data-veg-match}

l.d <- data.frame(le.raw[, -2:-3], l.raw[, -1:-3])
l.d <- split(l.d, l.d[, "Tree.ID"])
l.d <- l.d[names(l.d) %in% le.raw[, "Tree.ID"]]
l.d <- lapply(l.d, function(x) x[, -1])
l.d <- lapply(l.d, apply, 2, mean)
l.df <- do.call(rbind, l.d)
trt <- strsplit(rownames(l.df), "")
moth.alive <- lapply(trt, function(x) x[x %in% c(letters, LETTERS)][1:2])
moth.alive <- do.call(rbind, moth.alive)
tree <- lapply(trt, function(x) x[x %in% 0:9])
tree <- as.numeric(unlist(lapply(tree, paste, collapse = "")))
l.df <- data.frame(Tree.pairs = tree, 
                   Moth = moth.alive[, 1], 
                   Live.Dead = moth.alive[, 2], 
                   l.df)
l.df <- l.df[l.df[, "Live.Dead"] == "A", ]
l.df[, "Moth"] <- as.character(l.df[, "Moth"])
l.df[l.df[, "Moth"] == "R", "Moth"] <- 1
l.df[l.df[, "Moth"] == "S", "Moth"] <- 0
moth.tree <- paste(l.df[, "Moth"], l.df[, "Tree.pairs"], sep = "_")
l.df <- l.df[match(rownames(l.dat), moth.tree), ]

```

Check that `l.dat` and `l.df` are correctly coalesced:


```{r data-check-ldat, echo = FALSE}

all(l.df[, 1:2] == l.dat[, 1:2])
colnames(l.dat[, -10:-12]) == colnames(l.df)

```

Check that the values of the variables match, excluding light:

```{r data-check-ldat-head, echo = FALSE, results = "hide"}

head(l.dat[, c(-1:-3, -10:-12)] - l.df[, c(-1:-3)])

```

The following vector should work to match-up the saxicoles with the
veg data:

```{r data-match-vcom, echo = FALSE}

m.v <- rownames(l.df)
v.dat <- veg[match(m.v, veg[, "Tree ID"]), ]
v.dat[is.na(v.dat)] <- 0

v.tp <- v.dat[, "Tree ID"]
v.tp <- strsplit(v.tp, "")
v.tp <- unlist(lapply(v.tp, function(x) paste(x[x %in% 0:9], collapse = "")))
v.dat <- data.frame(v.dat[, 1:7], "Tree Pair" = v.tp, v.dat[, 8:ncol(v.dat)])
v.com <- v.dat[, 9:ncol(v.dat)]

v.com.ds <- cbind(v.com, ds = rep(1, nrow(v.com)))
v.com.ds.rel <- apply(v.com, 2, function(x) x/max(x))
v.com.ds.rel <- cbind(v.com.ds.rel, ds = rep(0.0001, nrow(v.com)))
v.com.ds.rel[is.na(v.com.ds.rel)] <- 0

```

Checking the vegetation and rock cover correlations. We find that
vegetation cover is is significantly, but not strongly correlated with
rock cover. Large rock cover measurements in the saxicole dataset is
strongly correlated with total rock cover in the plant dataset.

Both vegetation and rock cover are strongly affected by moth
susceptibility. 


```{r veg-cover}

cor.test(v.dat[, "Vegetation.cover"], v.dat[, "Rock.cover"], alt = "greater")
cor.test(l.dat[, "Big.rocks.."], v.dat[, "Rock.cover"], alt = "greater")
t.test(tapply(v.dat[, "Rock.cover"], v.dat[, "Tree.Pair"], diff))
t.test(tapply(v.dat[, "Vegetation.cover"], v.dat[, "Tree.Pair"], diff))

```

Both plant richness and Shannon's Diversity index were significantly
affected by moth susceptibility.

```{r veg-diversity}

v.abun <- v.dat[, "Vegetation.cover"]
v.rich <- apply(v.com, 1, function(x) sum(sign(x)))
v.shan <- apply(v.com, 1, diversity)

t.test(tapply(v.rich, l.dat[, "Tree.pairs"], diff))
t.test(tapply(v.shan, l.dat[, "Tree.pairs"], diff))

```

```{r veg-table-comstats}

v.ard.mu <- rbind(tapply(v.dat[, "Vegetation.cover"], l.dat[, "Moth"], mean),
                tapply(rich, l.dat[, "Moth"], mean),
                tapply(shan, l.dat[, "Moth"], mean))
v.ard.se <- rbind(tapply(v.dat[, "Vegetation.cover"], l.dat[, "Moth"], se),
                tapply(rich, l.dat[, "Moth"], se),
                tapply(shan, l.dat[, "Moth"], se))
v.ard.tab <- cbind(v.ard.mu[, "0"], v.ard.se[, "0"],
                   v.ard.mu[, "1"], v.ard.se[, "1"])
colnames(v.ard.tab) <- c("Susceptible Mean", "Susceptible SE",
                         "Resistant Mean", "Resistant SE")
rownames(v.ard.tab) <- c("Abundance", "Richness", "Diversity (Shannon)")

```

```{r table-veg-ard, results = "asis"}

kable(v.ard.tab, digits = 3)

```

This is a multivariate analysis of the plant community response to
moth susceptibility (PERMANOVA). This analysis uses a modified Bray-Curtis
Dissimilarity metric, which permits the inclusion of quadrats that had
no plants in them. The analysis also accounts for the paired structure
of the data (i.e. pairs of moth susceptible and resistant trees). 


```{r veg-moth-perm, cache = TRUE}

set.seed(123)
ptab.v.moth <- adonis2(v.com.ds ~ Moth, data = l.dat, 
                    strata = v.dat[, "Tree.pairs"], 
                    by = "margin", nperm = 100000)
set.seed(123)
ptab.v.moth.rel <- adonis2(v.com.ds.rel ~ Moth, data = l.dat, 
                         strata = v.dat[, "Tree.pairs"], 
                         by = "margin", nperm = 100000)

```

Here are the results of the multivariate plant community response.

```{r veg-moth-permtab, echo = TRUE}

kable(ptab.v.moth, caption = "PERMANOVA of plant community response to moth.")

```

Here are the results of the multivariate plant community response
after relativizing by species max.

```{r veg-rel-moth-permtab, echo = FALSE}

kable(ptab.v.moth.rel, caption = "PERMANOVA of relativized plant community response to moth.")

```

Do light, litter or rock cover influence plant communities?

```{r veg-env, cache = TRUE}

set.seed(123)
ptab.v.env <- adonis2(v.com.ds ~ Light...average + Litter.. + Big.rocks..,
                      data = l.dat, 
                      strata = l.dat[, "Tree.pairs"], 
                      by = "margin", nperm = 100000)
set.seed(123)
ptab.v.env.total.rocks <- adonis2(v.com.ds ~ Light...average + Litter.. + total.rocks,
                      data = l.dat, 
                      strata = l.dat[, "Tree.pairs"], 
                      by = "margin", nperm = 100000)
set.seed(123)
ptab.v.env.rel <- adonis2(v.com.ds.rel ~ Light...average + Litter.. + total.rocks,
                          data = l.dat, 
                          strata = l.dat[, "Tree.pairs"], 
                          by = "margin", nperm = 100000)
set.seed(123)
ptab.v.env.int <- adonis2(v.com.ds ~ Light...average + Litter.. + total.rocks +
                              Light...average * Litter.. +
                              Light...average * total.rocks +
                              Litter.. * total.rocks,
                          data = l.dat, 
                          strata = l.dat[, "Tree.pairs"], 
                          by = "margin", nperm = 100000)
set.seed(123)
ptab.v.env.rel.int <- adonis2(v.com.ds.rel ~ Light...average + Litter.. + total.rocks +
                              Light...average * Litter.. +
                              Light...average * total.rocks +
                              Litter.. * total.rocks,
                          data = l.dat, 
                          strata = l.dat[, "Tree.pairs"], 
                          by = "margin", nperm = 100000)

```

Light has a strong effect on the plant community. Litter also has an
effect but it is small and marginally significant, either
un-relativized or relativized, respectively.


```{r veg-env-permtab, echo = FALSE}

kable(ptab.v.env, caption = "PERMANOVA of plant community response to several environmental variables.")

```

```{r veg-rel-env-permtab, echo = FALSE}

kable(ptab.v.env.rel, caption = "PERMANOVA of relativized plant community response to several environmental variables.")

```


```{r veg-env-seq, cache = TRUE}

set.seed(123)
ptab.v.env.seq <- adonis2(v.com.ds ~ Light...average + Litter.. + total.rocks,
                      data = l.dat, 
                      strata = l.dat[, "Tree.pairs"], 
                      by = "term", nperm = 100000)
set.seed(123)
ptab.v.env.rel.seq <- adonis2(v.com.ds.rel ~ Light...average + Litter.. + total.rocks,
                          data = l.dat, 
                          strata = l.dat[, "Tree.pairs"], 
                          by = "term", nperm = 100000)

```

After controlling for the effect of light, the effect of litter is no
longer significant, un-relatvizied or relativized, respectivley.

```{r veg-env-seq-permtab, echo = FALSE}

kable(ptab.v.env.seq, caption = "Sequential PERMANOVA of plant community response to several environmental variables. Variance is explained sequentially by factors entered into the model from top to bottom.")

```

```{r veg-rel-env-seq-permtab, echo = FALSE}

kable(ptab.v.env.rel.seq, caption = "Sequential PERMANOVA of relativized plant community response to several environmental variables. Variance is explained sequentially by factors entered into the model from top to bottom.")

```


- Indicator species

```{r isp-veg, echo = FALSE}

ind.spp.v <- lapply(v.com, function(x, p) t.test(tapply(x, p, diff)), 
                    p = v.dat[, "Tree.Pair"])
isp.v <- apply(do.call(rbind, lapply(ind.spp.v, unlist)), 2, as.numeric)
rownames(isp.v) <- names(ind.spp.v)
isp.v[, "p.value"] <- p.adjust(isp.v[, "p.value"], method = "fdr")
isp.all.v <- isp.v[, !(apply(isp.v, 2, function(x) all(is.na(x))))]
isp.v <- isp.v[order(isp.v[, "p.value"]), ]
isp.all.v <- isp.all.v[, c(1, 2, 3, 6, 4, 5)]
isp.all.v <- isp.all.v[order(isp.all.v[, "estimate.mean of x"]), ]
colnames(isp.all.v) <- c("t", "df", "p-value", 
                         "Mean Difference", "Lower CI 95%", "Upper CI 95%")
v.isp.com <- v.com[, colnames(v.com) %in% rownames(isp.all.v)[isp.all.v[, "p-value"] < 0.05]]

```

There are two species that are responding to moth
susceptibility, Apache plume and *Asteraceae ovales*. 


```{r isp-veg-table, echo = FALSE}

kable(isp.all.v[, 1:6], digits = 4, caption = "Indicator Species Analysis using False Discovery Rate (FDR) adjusted p-values from t-tests of paired differences between resistant and susceptible trees (Resistant - Susceptible).")

```

## Multivariate Correlation of Plants and Saxicoles

There is no significant multivariate correlation between the veg and
saxicole communities, regardless of whether the community data are
relativized. This is likely a result of the two communities responded
to different variables with low correlation (i.e. rocks = saxicoles
and light = plants). This was true either without or with
relativization by species max.

```{r lv-mantel, cache = TRUE}

v.d <- vegdist(v.com.ds)
l.d <- vegdist(com.ds)

mantel(v.d ~ l.d)

v.d <- vegdist(v.com.ds.rel)
l.d <- vegdist(com.ds.rel)

mantel(v.d ~ l.d)

```






# Structural Equation Modeling




```{r exp-dist}


com.prepared <- cbind(id = l.dat[, "Moth"], tree  = l.dat[, "Tree.pairs"], com)
v.com.prepared <- cbind(id = l.dat[, "Moth"], tree  = l.dat[, "Tree.pairs"], v.com)

l.dist.euc <- distancePairedSamples(
    sequences = com.prepared,
    grouping.column = "id",
    time.column = "tree",
    exclude.columns = NULL,
    method = "euclidean",
    sum.distances = FALSE,
    parallel.execution = FALSE
)

l.dist.man <- distancePairedSamples(
    sequences = com.prepared,
    grouping.column = "id",
    time.column = "tree",
    exclude.columns = NULL,
    method = "manhattan",
    sum.distances = FALSE,
    parallel.execution = FALSE
)

v.dist.euc <- distancePairedSamples(
    sequences = v.com.prepared,
    grouping.column = "id",
    time.column = "tree",
    exclude.columns = NULL,
    method = "euclidean",
    sum.distances = FALSE,
    parallel.execution = FALSE
)

v.dist.man <- distancePairedSamples(
    sequences = v.com.prepared,
    grouping.column = "id",
    time.column = "tree",
    exclude.columns = NULL,
    method = "manhattan",
    sum.distances = FALSE,
    parallel.execution = FALSE
)

cor(l.dist.man[[1]], l.dist.euc[[1]])
cor(v.dist.man[[1]], v.dist.euc[[1]])

```



```{r exp-sem-lichen}

d.litter <- tapply(l.dat[, "Litter.."], l.dat[, "Tree.pairs"], diff)
d.rocks <- tapply((l.dat[, "Big.rocks.."] + l.dat[, "Small.rocks.."]), 
                  l.dat[, "Tree.pairs"], diff)
d.light <- tapply(l.dat[, "Light...average"], l.dat[, "Tree.pairs"], diff)
d.com <- l.dist.man[[1]]
d.abun <- tapply(abun, l.dat[, "Tree.pairs"], diff)
d.rich <- tapply(rich, l.dat[, "Tree.pairs"], diff)
d.shan <- tapply(shan, l.dat[, "Tree.pairs"], diff)
d.isp <- apply(isp.com, 2, function(x, f) tapply(x, f, diff), f = l.dat[, "Tree.pairs"])
colnames(d.isp) <- paste("d", colnames(isp.com), sep = ".")

round(cor(cbind(d.litter, d.rocks, d.light, d.abun, d.rich, d.shan, d.com)), 3)

sem.dat <- data.frame(d.litter, d.rocks, d.light, d.abun, d.rich, d.shan, d.com, d.isp)
sem.path <- matrix(c(0, 1, 1, 0, 
                     1, 0, 0, 1, 
                     0, 0, 0, 1, 
                     0, 0, 0, 0), 4, 4, byrow = TRUE)
rownames(sem.path) <- colnames(sem.path) <- c("d.litter", "d.light", "d.rocks", "d.com")

model.com  <- psem(lm(d.rocks ~ d.litter, sem.dat), lm(d.com ~ d.light + d.rocks, sem.dat))
model.com1  <- psem(lm(d.rocks ~ d.litter, sem.dat), lm(d.com ~ d.litter + d.light + d.rocks, sem.dat))
model.abun <- psem(lm(d.rocks ~ d.litter, sem.dat), lm(d.abun ~ d.light + d.rocks, sem.dat))
model.rich <- psem(lm(d.rocks ~ d.litter, sem.dat), lm(d.rich ~ d.light + d.rocks, sem.dat))
model.shan <- psem(lm(d.rocks ~ d.litter, sem.dat), lm(d.shan ~ d.light + d.rocks, sem.dat))
model.Acacon <- psem(lm(d.rocks ~ d.litter, sem.dat), lm(d.Acacon ~ d.light + d.rocks, sem.dat))
model.Acaame <- psem(lm(d.rocks ~ d.litter, sem.dat), lm(d.Acaame ~ d.light + d.rocks, sem.dat))
model.Canros <- psem(lm(d.rocks ~ d.litter, sem.dat), lm(d.Canros ~ d.light + d.rocks, sem.dat))
model.Canros1 <- psem(lm(d.rocks ~ d.litter, sem.dat),  lm(d.Canros ~ d.light + d.rocks, sem.dat))

```

```{r exp-sem-veg}

d.litter <- tapply(l.dat[, "Litter.."], l.dat[, "Tree.pairs"], diff)
d.rocks <- tapply((l.dat[, "Big.rocks.."] + l.dat[, "Small.rocks.."]), 
                  l.dat[, "Tree.pairs"], diff)
d.light <- tapply(l.dat[, "Light...average"], l.dat[, "Tree.pairs"], diff)

d.v.com <- v.dist.man[[1]]
d.v.abun <- tapply(v.abun, l.dat[, "Tree.pairs"], diff)
d.v.rich <- tapply(v.rich, l.dat[, "Tree.pairs"], diff)
d.v.shan <- tapply(v.shan, l.dat[, "Tree.pairs"], diff)
d.v.isp <- apply(v.isp.com, 2, function(x, f) tapply(x, f, diff), f = l.dat[, "Tree.pairs"])
colnames(d.v.isp) <- paste("d", colnames(v.isp.com), sep = ".")
v.sem.dat <- data.frame(d.litter, d.rocks, d.light, d.v.abun, d.v.rich, d.v.shan, d.v.com, d.v.isp)

model.v.com  <- psem(lm(d.rocks ~ d.litter, v.sem.dat), lm(d.v.com ~ d.light + d.rocks, v.sem.dat))
model.v.com1  <- psem(lm(d.rocks ~ d.litter, v.sem.dat), lm(d.v.com ~ d.litter + d.light + d.rocks, v.sem.dat))
model.v.abun <- psem(lm(d.rocks ~ d.litter, v.sem.dat), lm(d.v.abun ~ d.light + d.rocks, v.sem.dat))
model.v.rich <- psem(lm(d.rocks ~ d.litter, v.sem.dat), lm(d.v.rich ~ d.light + d.rocks, v.sem.dat))
model.v.shan <- psem(lm(d.rocks ~ d.litter, v.sem.dat), lm(d.v.shan ~ d.light + d.rocks, v.sem.dat))
model.v.Apache.plume <- psem(lm(d.rocks ~ d.litter, v.sem.dat), 
                             lm(d.Apache.plume ~ d.light + d.rocks, v.sem.dat))
model.v.Asteraceae.ovales <- psem(lm(d.rocks ~ d.litter, v.sem.dat), 
                                  lm(d.Asteraceae.ovales ~ d.light + d.rocks, v.sem.dat))

```


# Independent Test Method

Using indeendent tests for different effects along the hypothesized
causal model that moth susceptibility affects tree traits (litter
production), which affect the local environment (light, rocks), which
in turn affect lichen, bryophyte and plant communities (abundance,
richness, diversity, indicator species, composition).

moth-susceptibility -> tree traits -> local environment -> community

We can do this by parsing independent tests for each effect OR by
using a structural equation model (SEM).


Testing for the effect of moth susceptibility:

```{r itm-moth-tree, cache = TRUE}

t.test(d.litter)
t.test(d.light)
t.test(d.rocks)

```

Effects of tree traits on local environment and environment correlations:

```{r itm-tree-env, cache = TRUE}

cor.test(d.light, d.litter)
cor.test(d.rocks, d.light)
summary(lm(d.rocks ~ d.litter))

```

Effects of local environment on lichen, and possible direct effects of tree traits:

```{r itm-lichen, cache = TRUE}

summary(lm(d.abun ~ d.rocks))
summary(lm(d.rich ~ d.rocks))
summary(lm(d.shan ~ d.rocks))
summary(lm(d.Acacon ~ d.rocks, sem.dat))
summary(lm(d.Acaame ~ d.rocks, sem.dat))
summary(lm(d.Canros ~ d.rocks, sem.dat))

summary(lm(d.abun ~ d.light))
summary(lm(d.rich ~ d.light))
summary(lm(d.shan ~ d.light))
summary(lm(d.Acacon ~ d.light, sem.dat))
summary(lm(d.Acaame ~ d.light, sem.dat))
summary(lm(d.Canros ~ d.light, sem.dat))

summary(lm(d.abun ~ d.litter))
summary(lm(d.rich ~ d.litter))
summary(lm(d.shan ~ d.litter))
summary(lm(d.Acacon ~ d.litter, sem.dat))
summary(lm(d.Acaame ~ d.litter, sem.dat))
summary(lm(d.Canros ~ d.litter, sem.dat))


```

SEM testing for this pathway, note that here community distance is the
sum of squared differences for each tree pair (susceptible -
resistant) for all species:

```{r sem-lichen, cache = TRUE}

summary(model.abun, .progressBar = FALSE)
summary(model.rich, .progressBar = FALSE)
summary(model.shan, .progressBar = FALSE)
summary(model.com, .progressBar = FALSE)
summary(model.Acacon, .progressBar = FALSE)
summary(model.Acaame, .progressBar = FALSE)
summary(model.Canros, .progressBar = FALSE)

```



```{r itm-veg, cache = TRUE}

summary(lm(d.v.abun ~ d.rocks))
summary(lm(d.v.rich ~ d.rocks))
summary(lm(d.v.shan ~ d.rocks))
summary(lm(d.Apache.plume ~ d.rocks, v.sem.dat))
summary(lm(d.Asteraceae.ovales ~ d.rocks, v.sem.dat))

summary(lm(d.v.abun ~ d.litter))
summary(lm(d.v.rich ~ d.litter))
summary(lm(d.v.shan ~ d.litter))
summary(lm(d.Apache.plume ~ d.litter, v.sem.dat))
summary(lm(d.Asteraceae.ovales ~ d.litter, v.sem.dat))

summary(lm(d.v.abun ~ d.light))
summary(lm(d.v.rich ~ d.light))
summary(lm(d.v.shan ~ d.light))
summary(lm(d.Apache.plume ~ d.light, v.sem.dat))
summary(lm(d.Asteraceae.ovales ~ d.light, v.sem.dat))

summary(model.v.com, .progressBar = FALSE)
summary(model.v.abun, .progressBar = FALSE)
summary(model.v.rich, .progressBar = FALSE)
summary(model.v.shan, .progressBar = FALSE)
summary(model.v.Apache.plume, .progressBar = FALSE)
summary(model.v.Asteraceae.ovales, .progressBar = FALSE)

```

# Analyses for Revisions


Tree -> Moth -> Trait -> Loc env -> Community (A, R, D, Comp)

Pair    S/R     Crown    Litter     Lichen
                         Rocks      Plants
                         Light


```{r org-data, eval = TRUE, echo = FALSE, results = "hide", cache = TRUE}

tree.dim <- read.csv("data/tree dimensions.csv")
colnames(tree.dim) <- paste(colnames(tree.dim), tree.dim[1, ])
tree.dim <- tree.dim[-1, ]
tree.dim <- tree.dim[!(grepl("D", tree.dim[,1])), ]

traits <- data.frame(trunk.radius = tree.dim[, "Trunk.2 Radius (cm)"],
                      crown.radius = tree.dim[, "Average.radius with trunk (cm)"], 
                      litter = l.dat[, "Litter.."])
traits <- data.frame(apply(traits, 2, as.numeric))
tra.dif <- split(traits, l.dat[, "Tree.pairs"])
tra.dif <- lapply(tra.dif, function(x) x[2, ] - x[1, ])
tra.dif <- do.call(rbind, tra.dif)

env.dif <- data.frame(rocks = l.dat[, "Big.rocks.."] + l.dat[, "Small.rocks.."],
                      rock.lg = l.dat[, "Big.rocks.."],
                      rock.sm = l.dat[, "Small.rocks.."],
                      light = l.dat[, "Light...average"]
                      )
env.dif <- data.frame(apply(env.dif, 2, as.numeric))
env.dif <- split(env.dif, l.dat[, "Tree.pairs"])
env.dif <- lapply(env.dif, function(x) x[2, ] - x[1, ])
env.dif <- do.call(rbind, env.dif)

l.com.dif <- split(com, l.dat[, "Tree.pairs"])
l.com.dif <- lapply(l.com.dif, function(x) x[2, ] - x[1, ])
l.com.dif <- do.call(rbind, l.com.dif)

v.com.dif <- split(v.com, l.dat[, "Tree.pairs"])
v.com.dif <- lapply(v.com.dif, function(x) x[2, ] - x[1, ])
v.com.dif <- do.call(rbind, v.com.dif)

l.ard <- t(apply(com, 1, function(x) c(A = sum(x), 
                                     R = sum(sign(x)), 
                                     D = diversity(x))))
v.ard <- t(apply(v.com, 1, function(x) c(A = sum(x), 
                                     R = sum(sign(x)), 
                                     D = diversity(x))))
l.ard.dif <- apply(l.ard, 2, 
                   function(x, f) 
                       tapply(x, f, diff), 
                   f = l.dat[, "Tree.pairs"])
colnames(l.ard.dif) <- paste0("l.", colnames(l.ard.dif))
v.ard.dif <- apply(v.ard, 2, 
                   function(x, f) 
                       tapply(x, f, diff), 
                   f = l.dat[, "Tree.pairs"])
colnames(v.ard.dif) <- paste0("p.", colnames(v.ard.dif))

tra.dif.d <- dist(tra.dif)
l.com.dif.d <- dist(l.com.dif)
v.com.dif.d <- dist(v.com.dif)
env.dif.d <- dist(env.dif)

ind.env.dif.d <- lapply(split(as.matrix(env.dif), col(env.dif)), dist)
names(ind.env.dif.d) <- colnames(env.dif)



```

## Lichen and plant community resposnes are not correlated

``{r mantel-l-v}

mantel(l.com.dif.d ~ v.com.dif.d)

```

## Both lichen and vegetation respond to moth susceptibility

```{r moth-com, results = "asis", cache = TRUE}

set.seed(12345)
xtable::xtable(adonis2(com.ds ~ Moth, 
                       strata = l.dat[, "Tree.pairs"], 
                       data = l.dat, 
                       perm = 9999)
               )

set.seed(12345)
xtable::xtable(adonis2(v.com.ds ~ Moth, 
                       strata = l.dat[, "Tree.pairs"], 
                       data = l.dat, 
                       perm = 9999)
               )


```


```{r moth-ard, results = "asis"}

tab.ttest.ard <- do.call(rbind, 
                        lapply(
                            apply(data.frame(l.ard.dif, v.ard.dif), 2, 
                                  t.test), 
                            unlist))[, c(1, 2, 6, 3)]
tab.lab <- rownames(tab.ttest.ard)
tab.ttest.ard <- apply(tab.ttest.ard, 2, as.numeric)
rownames(tab.ttest.ard) <- tab.lab
xtable::xtable(tab.ttest.ard, digits = 5)

```


## Moth impacts tree traits and the local environment

```{r moth-env, results = "asis"}

tab.ttest.envtra <- do.call(rbind, 
                        lapply(
                            apply(data.frame(tra.dif, env.dif), 2, 
                                  t.test), 
                            unlist))[, c(1, 2, 6, 3)]
tab.lab <- rownames(tab.ttest.envtra)
tab.ttest.envtra <- apply(tab.ttest.envtra, 2, as.numeric)
rownames(tab.ttest.envtra) <- tab.lab
xtable::xtable(tab.ttest.envtra, digits = 5)

```

## Tree environment correlate with community

```{r tra-com, cache = TRUE}

set.seed(12345)
xtable::xtable(adonis2(com.ds ~ Big.rocks.. + Small.rocks.. + Light...average,
                       strata = l.dat[, "Tree.pairs"], 
                       by = "margin",
                       data = data.frame(env, traits),
                       perm = 9999, rank = TRUE)
               )

set.seed(12345)
xtable::xtable(adonis2(v.com.ds ~ Light...average + Big.rocks.. + Small.rocks..,
                       strata = l.dat[, "Tree.pairs"], 
                       by = "margin",
                       data = data.frame(env, traits),
                       perm = 9999)
               )


summary(lm(l.A ~ rock.lg * rock.sm * light,
           data = data.frame(l.ard.dif, tra.dif, env.dif)))
summary(lm(l.R ~ rock.lg * rock.sm * light,
           data = data.frame(l.ard.dif, tra.dif, env.dif)))
summary(lm(l.D ~ rock.lg * rock.sm * light,
           data = data.frame(l.ard.dif, tra.dif, env.dif)))

summary(lm(l.A ~ light *rock.lg * rock.sm,
           data = data.frame(l.ard.dif, tra.dif, env.dif)))
summary(lm(l.R ~ light *rock.lg * rock.sm,
           data = data.frame(l.ard.dif, tra.dif, env.dif)))
summary(lm(l.D ~ light *rock.lg * rock.sm,
           data = data.frame(l.ard.dif, tra.dif, env.dif)))

summary(lm(l.A ~ rock.lg + rock.sm + light,
           data = data.frame(l.ard.dif, tra.dif, env.dif)))
summary(lm(l.R ~ rock.lg + rock.sm + light,
           data = data.frame(l.ard.dif, tra.dif, env.dif)))
summary(lm(l.D ~ rock.lg + rock.sm + light,
           data = data.frame(l.ard.dif, tra.dif, env.dif)))

summary(lm(l.A ~ light +rock.lg + rock.sm,
           data = data.frame(l.ard.dif, tra.dif, env.dif)))
summary(lm(l.R ~ light +rock.lg + rock.sm,
           data = data.frame(l.ard.dif, tra.dif, env.dif)))
summary(lm(l.D ~ light +rock.lg + rock.sm,
           data = data.frame(l.ard.dif, tra.dif, env.dif)))

summary(lm(p.A ~ rock.lg * rock.sm * light,
           data = data.frame(v.ard.dif, tra.dif, env.dif)))
summary(lm(p.R ~ rock.lg * rock.sm * light,
           data = data.frame(v.ard.dif, tra.dif, env.dif)))
summary(lm(p.D ~ rock.lg * rock.sm * light,
           data = data.frame(v.ard.dif, tra.dif, env.dif)))

summary(lm(p.A ~ light *rock.lg * rock.sm,
           data = data.frame(v.ard.dif, tra.dif, env.dif)))
summary(lm(p.R ~ light *rock.lg * rock.sm,
           data = data.frame(v.ard.dif, tra.dif, env.dif)))
summary(lm(p.D ~ light *rock.lg * rock.sm,
           data = data.frame(v.ard.dif, tra.dif, env.dif)))

summary(lm(p.A ~ rock.lg + rock.sm + light,
           data = data.frame(v.ard.dif, tra.dif, env.dif)))
summary(lm(p.R ~ rock.lg + rock.sm + light,
           data = data.frame(v.ard.dif, tra.dif, env.dif)))
summary(lm(p.D ~ rock.lg + rock.sm + light,
           data = data.frame(v.ard.dif, tra.dif, env.dif)))

summary(lm(p.A ~ light +rock.lg + rock.sm,
           data = data.frame(v.ard.dif, tra.dif, env.dif)))
summary(lm(p.R ~ light +rock.lg + rock.sm,
           data = data.frame(v.ard.dif, tra.dif, env.dif)))
summary(lm(p.D ~ light +rock.lg + rock.sm,
           data = data.frame(v.ard.dif, tra.dif, env.dif)))

```

## Structural Equation Models

```{r sem-com-ord, cache = TRUE}

l.com.dif <- split(com, l.dat[, "Tree.pairs"])
l.com.dif <- lapply(l.com.dif, function(x) x[2, ] - x[1, ])
l.com.dif <- do.call(rbind, l.com.dif)

v.com.dif <- split(v.com, l.dat[, "Tree.pairs"])
v.com.dif <- lapply(v.com.dif, function(x) x[2, ] - x[1, ])
v.com.dif <- do.call(rbind, v.com.dif)

l.com.dif.d <- dist(l.com.dif)
v.com.dif.d <- dist(v.com.dif)

l.com.dif.nms <- nmds(l.com.dif.d, 1, 2)
l.com.dif.ord <- nmds.min(l.com.dif.nms, 2)
l.com.dif.vec <- envfit(l.com.dif.ord, 
                        data.frame(env.dif, tra.dif)[, c("rock.lg",
                                                         "rock.sm",
                                                         "light",
                                                         "litter")])

v.com.dif.nms <- nmds(v.com.dif.d, 2, 3)
v.com.dif.ord <- nmds.min(v.com.dif.nms, 3)
v.com.dif.vec <- envfit(v.com.dif.ord,
                        data.frame(env.dif, tra.dif)[, c("rock.lg",
                                                         "rock.sm",
                                                         "light",
                                                         "litter")])

colnames(l.com.dif.ord) <- paste0("l.", colnames(l.com.dif.ord))
colnames(v.com.dif.ord) <- paste0("p.", colnames(v.com.dif.ord))

```

```{r proc-rot-ord}

l.com.dif.ord.proc <- procrustes(env.dif[, "rock.lg"], l.com.dif.ord)$Yrot
v.com.dif.ord.proc <- procrustes(env.dif[, "rock.sm"], v.com.dif.ord)$Yrot

colnames(l.com.dif.ord.proc) <- paste0("rot.", colnames(l.com.dif.ord))
colnames(v.com.dif.ord.proc) <- paste0("rot.", colnames(v.com.dif.ord))

l.com.dif.vec.rot <- envfit(l.com.dif.ord.proc, 
                            data.frame(env.dif[, -1], litter = tra.dif[, "litter"]))
v.com.dif.vec.rot <- envfit(v.com.dif.ord.proc, 
                            data.frame(env.dif[, -1], litter = tra.dif[, "litter"]))

```


```{r sem-data}

sem.dat <- data.frame(tra.dif, env.dif, l.ard.dif, v.ard.dif, l.com.dif.ord, v.com.dif.ord, l.com.dif.ord.proc, v.com.dif.ord.proc)
colnames(sem.dat)[colnames(sem.dat) == "crown.radius"] <- "crown"

```

```{r env-tests, results = "asis"}

tab.ttest.ldat <- do.call(rbind, 
                        lapply(
                            apply(l.dat[, -1:-3], 2, 
                                  t.test), 
                            unlist))[, c(1, 2, 6, 3)]
tab.lab <- rownames(tab.ttest.ldat)
tab.ttest.ldat <- apply(tab.ttest.ldat, 2, as.numeric)
rownames(tab.ttest.ldat) <- tab.lab
xtable::xtable(tab.ttest.ldat, digits = 5)
xtable::xtable(na.omit(tab.ttest.ldat[tab.ttest.ldat[, "p.value"] <= 0.05,]))

tab.ttest.vdat <- do.call(rbind, 
                        lapply(
                            apply(v.dat[, -1:-8], 2, 
                                  t.test), 
                            unlist))[, c(1, 2, 6, 3)]
tab.lab <- rownames(tab.ttest.vdat)
tab.ttest.vdat <- apply(tab.ttest.vdat, 2, as.numeric)
rownames(tab.ttest.vdat) <- tab.lab
xtable::xtable(tab.ttest.vdat, digits = 5)
xtable::xtable(na.omit(tab.ttest.vdat[tab.ttest.vdat[, "p.value"] <= 0.05,]))


```


```{r sem-lavaan}

lav.l.all <- 'light ~ crown
              litter ~ crown
              rock.lg ~ litter
              l.A ~ light + rock.lg 
              l.R ~ light + rock.lg 
              l.D ~ light + rock.lg 
              l.X1 ~ light + rock.lg 
              l.X2 ~ light + rock.lg 
              l.A ~~ l.R
              l.A ~~ l.D
              l.R ~~ l.D
              l.A ~~ l.X1
              l.R ~~ l.X1
             '
lav.v.all <- 'light ~ crown
              litter ~ crown
              rock.sm ~ litter
              p.A ~ light + rock.sm 
              p.R ~ light + rock.sm  + litter 
              p.D ~ light + rock.sm 
              p.X1 ~ light + rock.sm 
              p.X2 ~ light + rock.sm 
              p.X3 ~ light + rock.sm 
              p.A ~~ p.X2
              p.A ~~ p.R
              p.A ~~ p.D
              p.R ~~ p.D
              p.A ~~ p.X1
              p.R ~~ p.X1
             '
lav.l.rot.all <- 'light ~ crown
                  litter ~ crown
                  rock.lg ~ litter
                  l.A ~ light + rock.lg 
                  l.R ~ light + rock.lg 
                  l.D ~ light + rock.lg 
                  rot.l.X1 ~ light + rock.lg 
                  rot.l.X2 ~ light + rock.lg 
                  l.A ~~ l.R
                  l.A ~~ l.D
                  l.R ~~ l.D
                  l.A ~~ rot.l.X1
                  l.R ~~ rot.l.X1
                 '
lav.v.rot.all <- 'light ~ crown
                  litter ~ crown
                  rock.sm ~ litter
                  p.A ~ light + rock.sm 
                  p.R ~ light + rock.sm  + litter 
                  p.D ~ light + rock.sm 
                  rot.p.X1 ~ light + rock.sm 
                  rot.p.X2 ~ light + rock.sm 
                  rot.p.X3 ~ light + rock.sm 
                  p.A ~~ rot.p.X2
                  p.A ~~ p.R
                  p.A ~~ p.D
                  p.R ~~ p.D
                  p.A ~~ rot.p.X1
                  p.R ~~ rot.p.X1
                 '

std <- function(x){(x - mean(x)) / sd(x)}

fit.l.all.raw <- lavaan::sem(lav.l.all, data = sem.dat)
fit.v.all.raw <- lavaan::sem(lav.v.all, data = sem.dat)
fit.l.all <- lavaan::sem(lav.l.all, data = apply(sem.dat, 2, std))
fit.v.all <- lavaan::sem(lav.v.all, data = apply(sem.dat, 2, std))
fit.l.rot.all <- lavaan::sem(lav.l.rot.all, data = apply(sem.dat, 2, std))
fit.v.rot.all <- lavaan::sem(lav.v.rot.all, data = apply(sem.dat, 2, std))

summary(fit.l.all.raw)
summary(fit.v.all.raw)
summary(fit.l.all)
summary(fit.v.all)
summary(fit.l.rot.all)
summary(fit.v.rot.all)

```

## SEM Modification Indices

```{r sem-mod-indices-lichens, results = "asis"}

xtable::xtable(modindices(fit.l.rot.all))

```

```{r sem-mod-indices-plants, results = "asis"}

xtable::xtable(modindices(fit.v.rot.all))

```

## SEM Parameter Estimates


```{r sem-params, results = "asis"}

xtable::xtable(table_results(fit.l.all))
xtable::xtable(table_results(fit.v.all))
xtable::xtable(table_results(fit.l.rot.all))
xtable::xtable(table_results(fit.v.rot.all))

```

## SEM Model Fit Measures

```{r sem-fit-measures, results = "asis"}

sem.fm.l.all <- fitMeasures(fit.l.all)
sem.fm.v.all <- fitMeasures(fit.v.all)
sem.fm.l.rot.all <- fitMeasures(fit.l.rot.all)
sem.fm.v.rot.all <- fitMeasures(fit.v.rot.all)

sem.fm.tab.all <- rbind(sem.fm.l.all[c("chisq", "df", "pvalue")],
                        sem.fm.v.all[c("chisq", "df", "pvalue")])
rownames(sem.fm.tab.all) <- c("Lichens", "Plants")
colnames(sem.fm.tab.all) <- c("$\\chi^{2}$", "\\textit{df}", "\\textit{p}-value")
sem.fm.tab.rot.all <- rbind(sem.fm.l.rot.all[c("chisq", "df", "pvalue")],
                        sem.fm.v.rot.all[c("chisq", "df", "pvalue")])
rownames(sem.fm.tab.rot.all) <- c("Lichens", "Plants")
colnames(sem.fm.tab.rot.all) <- c("$\\chi^{2}$", "\\textit{df}", "\\textit{p}-value")

print(xtable::xtable(sem.fm.tab.all, digits = 3), 
                     sanitize.text.function = function(x) {x})
print(xtable::xtable(sem.fm.tab.rot.all, digits = 3), 
                     sanitize.text.function = function(x) {x})

```



## Ordination Plots


```{r plot-ord}

par(mfrow = c(1,2))
plot(l.com.dif.ord[, 1:2], xlab = "Axis 1", ylab = "Axis 2", pch = 19)
plot(l.com.dif.vec, add = TRUE)
plot(v.com.dif.ord[, 1:2], xlab = "Axis 1", ylab = "Axis 2", pch = 19)
plot(v.com.dif.vec, add = TRUE)

```

```{r plot-ord-rot}

par(mfrow = c(1,2))
plot(l.com.dif.ord.proc[, 1:2], xlab = "Axis 1", ylab = "Axis 2", pch = 19)
plot(l.com.dif.vec.rot, add = TRUE)
plot(v.com.dif.ord.proc[, 1:2], xlab = "Axis 1", ylab = "Axis 2", pch = 19)
plot(v.com.dif.vec.rot, add = TRUE)

```


## SEM Plots


```{r plot-sem-tidy-lichen}

lay <- get_layout("crown", "light", "",     "l.A",
                  "",      "", "",            "",
                  "",      "litter", "",          "l.R",
                  "",      "", "",            "",
                  "",      "", "",          "l.D",
                  "",      "", "",            "",
                  "",      "", "",    "l.X1",
                  "",      "rock.lg", "", "l.X2",
                  rows = 8)
tg.l.all <- prepare_graph(fit.l.all, layout = lay)
plot(tg.l.all)

```

```{r plot-sem-tidy-plant}

lay <- get_layout("crown", "light", "",            "p.A",
                  "",      "", "",            "",
                  "",      "litter", "",       "p.R",
                  "",      "", "",            "",
                  "",      "", "",            "p.D",
                  "",      "", "",            "",
                  "",      "", "",      "p.X1",
                  "",      "rock.sm", "", "p.X2",
                  "",    "", "",     "p.X3",
                  rows = 9)

tg.v.all <- prepare_graph(fit.v.all, layout = lay)
plot(tg.v.all)

```

```{r plot-sem-tidy-lichen-rot}

lay <- get_layout("crown", "light", "",     "l.A",
                  "",      "", "",    "",
                  "",      "", "",          "l.R",
                  "",      "litter", "",          "l.D",
                  "",      "", "",    "rot.l.X1",
                  "",      "rock.lg", "", "",
                  rows = 6)

tg.l.rot.all <- prepare_graph(fit.l.rot.all, layout = lay)
plot(tg.l.rot.all)

```

```{r plot-sem-tidy-plant-rot}

lay <- get_layout("crown", "light", "",            "p.A",
                  "",      "", "",       "p.R",
                  "",      "litter", "",            "p.D",
                  "", "", "", "", 
                  "",      "", "", "rot.p.X1",
                  "",      "rock.sm", "", "",
                  rows = 6)

tg.v.rot.all <- prepare_graph(fit.v.rot.all, layout = lay)
plot(tg.v.rot.all)

```


## Causal Pathway of Moth Susceptibility Effects on Communities


- Moth susceptiblity indirectly influences plants and lichen
   1. Canopy effect of moth increases litter effects but does not
   affect light differences
   2. Differences in litter between moth susceptible and resistant
   trees decreases the differences of both large and small rocks
   3. Differnces in large rocks increases lichen community differences
      (abundance, richness, diversity, composition) and the difference
      in small rocks decreases the plant community differences
      (abundance richness, diversity and composition) between
      susceptible and resistant trees
- Both SEMs (lichen and plant) showed accetable goodness of fit
- See SEM path diagrams

